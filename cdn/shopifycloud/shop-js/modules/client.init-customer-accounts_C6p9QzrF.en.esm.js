import{_ as t,bP as e,bQ as n,bY as o,B as i,bR as s,bZ as a,ar as r,bS as c,bT as d,bX as u,b2 as l,aG as m,D as p,bM as h,b9 as f,ba as v,bN as w}from"./chunk.common_CTPs4D8t.esm.js";import{C as g,d as b,a as y}from"./client.login-button_BXY0vbFt.en.esm.js";class C{constructor(t){this.emailInput=t,this.passwordInput=this.findPasswordInput()}start(){var t;this.emailInput.addEventListener("input",this.trackEmailChange.bind(this)),null===(t=this.passwordInput)||void 0===t||t.addEventListener("input",this.trackPasswordChange.bind(this))}stop(){var t;this.emailInput.removeEventListener("input",this.trackEmailChange),null===(t=this.passwordInput)||void 0===t||t.removeEventListener("input",this.trackPasswordChange)}isFilledWithPasswordManager(){if(void 0!==this.emailLastUpdated&&void 0!==this.passwordLastUpdated){return Math.abs(this.emailLastUpdated-this.passwordLastUpdated)<100}}trackEmailChange(t){this.emailLastUpdated=t.timeStamp}trackPasswordChange(t){this.passwordLastUpdated=t.timeStamp}findPasswordInput(){var t;return null===(t=this.emailInput.form)||void 0===t?void 0:t.querySelector('input[type="password"]')}}class I extends Error{constructor(){super("FedCM is not supported")}}class E extends Error{constructor(){super("FedCM was cancelled")}}const _=e=>t(void 0,void 0,void 0,(function*(){if(!("IdentityCredential"in window))throw new I;const{mediation:n="optional",analyticsTraceId:o,monorailTracker:i}=e,s=yield function(e){return t(this,void 0,void 0,(function*(){let t="/services/login_with_shop/fedcm/provider";e&&(t+=`?analyticsTraceId=${encodeURIComponent(e)}`);const n=yield fetch(t,{method:"GET"}),o=yield n.json();return{configURL:o.configURL,clientId:o.clientId,nonce:o.nonce,state:o.state}}))}(o),a=yield function(t,e){return navigator.credentials.get({identity:{providers:[e]},mediation:t})}(n,s);if(!a)throw null==i||i.trackFedCMCancelledUserAction(),new E;return function(e,n,o){return t(this,void 0,void 0,(function*(){const t=yield fetch("/services/login_with_shop/fedcm/callback",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({raw_id_token:e,state:n}).toString()});return null==o||o.trackFedCMCompletedUserAction(),t}))}(a.token,s.state,i)}));function k(){return t(this,arguments,void 0,(function*(t=!1){if(!e("initCustomerAccounts")){n("initCustomerAccounts");try{if(o(window.location.pathname).endsWith("/account"))return void function(){const t=a("analytics_trace_id");if(t){new g({elementName:"shop-login-button",flowVersion:s.SignIn,analyticsTraceId:t}).trackClassicCustomerAccountsAccountPageImpression()}}();!function(t=!1){const e=r(),n=new g({elementName:"shop-login-button",flowVersion:s.SignIn,analyticsTraceId:e}),o=new WeakMap;let a=null;t&&y();const f=c({onVisible:e=>b({input:e,autoOpen:!t}),onFallback:t=>{t.addEventListener("focus",v,{once:!0}),n.trackShopPayLoginWithSdkErrorEvents({apiKey:"",errorCode:"fallback_to_focus_event",errorMessage:"Fallback to focus event for classic customer accounts"})}});function v(e){b({input:e.target,autoOpen:!t})}function w(t,e){var n,o;const i=null===(n=t.elements.namedItem("checkout_url"))||void 0===n?void 0:n.value,s=null===(o=t.elements.namedItem("return_url"))||void 0===o?void 0:o.value,a=new URLSearchParams(Object.assign(Object.assign({analytics_trace_id:e},i&&{checkout_url:i}),s&&{return_url:s}));return`${window.location.origin}/account/redirect?${a.toString()}`}function b({input:t,autoOpen:r}){var c,d;const u=t.form;if(!u)return void i.notify(new Error("Email form missing for classic customer accounts"));o.has(t)&&(i.notify(new Error("Input listener already exists for input")),null===(c=o.get(t))||void 0===c||c.destroy(),o.delete(t));const f=document.createElement("input");f.type="hidden",f.name="login_with_shop[analytics_trace_id]",f.value=e,u.appendChild(f);const v=new l("modalDismissed",!1);a||(a=function({analyticsTraceId:t,autoOpen:e}){let n,o=!1;n=document.querySelector("shop-login-button:not([action])"),n||(n=document.createElement("shop-login-button"),n.setAttribute("hide-button","true"),o=!0);n.setAttribute("client-id",""),n.setAttribute("action","default"),n.setAttribute("version","2"),n.setAttribute("flow-version",s.SignIn),n.setAttribute("analytics-context",p.ClassicCustomerAccounts),n.setAttribute("analytics-trace-id",t),n.setAttribute("disable-sign-up","true"),e&&n.setAttribute("auto-open","true");n.setAttribute("consent-challenge",""),Object.entries(h()).forEach((([t,e])=>{const o=t.replace(/_/g,"-");n.setAttribute(o,e)})),o&&document.body.appendChild(n);return n}({analyticsTraceId:e,autoOpen:r}),n.trackClassicCustomerAccountsLoginPageImpression(),a.addEventListener("completed",(()=>{const t=w(u,e);window.location.assign(t)})),a.addEventListener("modalclosed",(()=>{v.set(!0)})));const g=new C(t);g.start(),null===(d=a.setPasswordManagerDetection)||void 0===d||d.call(a,g),a.email=t.value,o.set(t,new m(t,(t=>{a.email=t})))}function y(){const t=document.querySelector("#customer_login");t&&_({mediation:"required",analyticsTraceId:e,monorailTracker:n}).then((n=>k(n,t,e))).catch((t=>A(t)))}function k(t,e,n){if(200!==t.status)return void i.notify(new Error("FedCM failed to authenticate"));if(!e)return void i.notify(new Error("FedCM failed to find the nearest form to leverage sign in URL"));const o=w(e,n);window.location.assign(o)}function A(t){t instanceof I||t instanceof E||"NetworkError"===t.name&&"Error retrieving a token."===t.message||i.notify(t)}d({selector:u,onElementFound:t=>f.observe(t)})}(t)}catch(t){if(t instanceof Error&&i.notify(t),t instanceof A){new g({elementName:"shop-login-button",flowVersion:s.SignIn,analyticsTraceId:t.analyticsTraceId}).trackShopPayLoginWithSdkErrorEvents({apiKey:"",errorCode:t.code,errorMessage:t.message})}}}}))}class A extends Error{constructor(t,e=r()){super(t),this.analyticsTraceId=e,this.name="InitCustomerAccountsError",this.code="init_customer_accounts_error"}}f()&&(v({bundle:"initCustomerAccounts",bundleLocale:"en"}),b(),y(),w("initCustomerAccounts",k));
//# sourceMappingURL=client.init-customer-accounts_C6p9QzrF.en.esm.js.map
